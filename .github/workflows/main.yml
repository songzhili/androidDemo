name: PR Merge -> Tag + Release

on:
  pull_request:
    branches: [ "main" ]
    types: [ closed ]   # 只在 PR 关闭时触发（包含 merged / not merged）

jobs:
  release_on_merge:
    if: ${{ github.event.pull_request.merged == true }}  # 只在“合并”时跑
    runs-on: ubuntu-latest

    permissions:
      contents: write   # push tag + 创建 GitHub Release 需要

    steps:
      - name: Checkout (full history for tags/changelog)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }} # 确保就是合并后的 commit
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # ---------------------------
      # 1) 自动生成 Tag
      #   优先从 app/build.gradle 里读 versionName（Groovy 常见写法）
      #   找不到就退化为 vYYYY.MM.DD.<run_number>
      # ---------------------------
      - name: Compute tag
        shell: bash
        run: |
          set -e

          VERSION_NAME=$(grep -R --line-number -m 1 'versionName ' . | sed -E 's/.*versionName[[:space:]]+"([^"]+)".*/\1/' || true)

          if [[ -n "$VERSION_NAME" && "$VERSION_NAME" != *"versionName"* ]]; then
            TAG="v$VERSION_NAME"
          else
            TAG="v$(date -u +%Y.%m.%d).${GITHUB_RUN_NUMBER}"
          fi

          echo "Computed tag: $TAG"
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Create and push git tag
        shell: bash
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          # 避免重复 tag（比如重跑 workflow）
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Skip creating tag."
          else
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
          fi

      # ---------------------------
      # 2) 解码 keystore（这里不在 if 表达式引用 secrets，避免你之前的 invalid workflow）
      # ---------------------------
      - name: Decode keystore
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          set -e
          if [ -z "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "ERROR: ANDROID_KEYSTORE_BASE64 is not set. Cannot build signed release."
            exit 1
          fi
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > keystore.jks
          echo "Keystore decoded."

      # ---------------------------
      # 3) 构建 Release APK + AAB
      # ---------------------------
      - name: Build Release APK & AAB
        env:
          KEYSTORE_PATH: ${{ github.workspace }}/keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          ./gradlew clean assembleRelease bundleRelease --stacktrace

      - name: Collect release files
        shell: bash
        run: |
          set -e
          mkdir -p release_out

          APK=$(ls -1 **/build/outputs/apk/release/*.apk 2>/dev/null | head -n 1 || true)
          AAB=$(ls -1 **/build/outputs/bundle/release/*.aab 2>/dev/null | head -n 1 || true)

          if [ -z "$APK" ] && [ -z "$AAB" ]; then
            echo "ERROR: No release APK/AAB found."
            exit 1
          fi

          [ -n "$APK" ] && cp "$APK" release_out/
          [ -n "$AAB" ] && cp "$AAB" release_out/

          echo "Release artifacts:"
          ls -la release_out

      # ---------------------------
      # 4) 自动生成 changelog（上一个 tag -> 当前 TAG）
      # ---------------------------
      - name: Generate changelog
        shell: bash
        run: |
          set -e

          # 找到上一个 tag（按创建时间/语义可能不同，这里用 git describe 方式）
          PREV_TAG=$(git describe --tags --abbrev=0 "$TAG^" 2>/dev/null || true)

          echo "Current tag: $TAG"
          echo "Previous tag: ${PREV_TAG:-<none>}"

          {
            echo "## Changelog"
            echo
            if [ -n "$PREV_TAG" ]; then
              echo "**Changes since $PREV_TAG**"
              echo
              git log "$PREV_TAG..HEAD" --pretty=format:"- %s (%h) @%an" --no-merges
            else
              echo "**First release**"
              echo
              git log --pretty=format:"- %s (%h) @%an" --no-merges -n 200
            fi
            echo
            echo "---"
            echo "Merged PR: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}"
          } > CHANGELOG.md

      # ---------------------------
      # 5) 创建 GitHub Release + 上传 APK/AAB
      # ---------------------------
      - name: Create GitHub Release (attach APK/AAB)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: Release ${{ env.TAG }}
          body_path: CHANGELOG.md
          files: |
            release_out/*
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
