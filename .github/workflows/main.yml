name: PR Merge -> Tag + Release

on:
  pull_request:
    branches: [ "main" ]
    types: [ closed ]

jobs:
  release_on_merge:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout (full history for tags/changelog)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # ---------------------------
      # 1) 自动生成 Tag（KTS 项目建议用 versionName = "x.y.z" 这种正则）
      # ---------------------------
      - name: Compute tag
        shell: bash
        run: |
          set -e

          VERSION_NAME=$(grep -R --line-number -m 1 'versionName[[:space:]]*=' . 2>/dev/null \
            | sed -E 's/.*versionName[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/' || true)

          if [[ -n "$VERSION_NAME" && "$VERSION_NAME" != *"versionName"* ]]; then
            TAG="v$VERSION_NAME"
          else
            TAG="v$(date -u +%Y.%m.%d).${GITHUB_RUN_NUMBER}"
          fi

          echo "Computed tag: $TAG"
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Create and push git tag
        shell: bash
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Skip creating tag."
          else
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
          fi

      # ---------------------------
      # 2) 解码 keystore
      # ---------------------------
      - name: Decode keystore
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          set -e
          if [ -z "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "ERROR: ANDROID_KEYSTORE_BASE64 is not set."
            exit 1
          fi
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > keystore.jks
          ls -lh keystore.jks

      # ---------------------------
      # 3) 诊断：签名报告（最关键）
      # ---------------------------
      - name: Signing report (must show release signing)
        env:
          CI: "true"
          KEYSTORE_FILE: ${{ github.workspace }}/keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          ./gradlew :app:signingReport --no-daemon

      # ---------------------------
      # 4) 构建 Release APK + AAB（使用正确的 env 变量名）
      # ---------------------------
      - name: Build Release APK & AAB (SIGNED)
        env:
          CI: "true"
          KEYSTORE_FILE: ${{ github.workspace }}/keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          ./gradlew clean :app:assembleRelease :app:bundleRelease --stacktrace --no-daemon

      # ---------------------------
      # 5) 只收集“已签名”的 APK（排除 *unsigned*） + AAB
      # ---------------------------
      - name: Collect release files (exclude unsigned)
        shell: bash
        run: |
          set -e
          mkdir -p release_out

          echo "All APKs:"
          find app/build/outputs/apk -type f -name "*.apk" -print || true
          echo "All AABs:"
          find app/build/outputs/bundle -type f -name "*.aab" -print || true

          # 排除 unsigned
          APK=$(find app/build/outputs/apk -type f -name "*.apk" ! -name "*unsigned*" | head -n 1 || true)
          AAB=$(find app/build/outputs/bundle -type f -name "*.aab" | head -n 1 || true)

          if [ -z "$APK" ] && [ -z "$AAB" ]; then
            echo "ERROR: No signed release APK/AAB found."
            exit 1
          fi

          [ -n "$APK" ] && cp "$APK" release_out/
          [ -n "$AAB" ] && cp "$AAB" release_out/

          echo "Release artifacts:"
          ls -la release_out

      # ---------------------------
      # 6) 校验 APK 签名（如果没签名这里会失败）
      # ---------------------------
      - name: Verify APK signature
        shell: bash
        run: |
          set -e
          APK=$(ls -1 release_out/*.apk 2>/dev/null | head -n 1 || true)
          if [ -n "$APK" ]; then
            apksigner verify -v "$APK"
          else
            echo "No APK found in release_out (maybe only AAB)."
          fi

      # ---------------------------
      # 7) changelog（上一个 tag -> 当前 TAG）
      # ---------------------------
      - name: Generate changelog
        shell: bash
        run: |
          set -e

          PREV_TAG=$(git describe --tags --abbrev=0 "$TAG^" 2>/dev/null || true)

          echo "Current tag: $TAG"
          echo "Previous tag: ${PREV_TAG:-<none>}"

          {
            echo "## Changelog"
            echo
            if [ -n "$PREV_TAG" ]; then
              echo "**Changes since $PREV_TAG**"
              echo
              git log "$PREV_TAG..HEAD" --pretty=format:"- %s (%h) @%an" --no-merges
            else
              echo "**First release**"
              echo
              git log --pretty=format:"- %s (%h) @%an" --no-merges -n 200
            fi
            echo
            echo "---"
            echo "Merged PR: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}"
          } > CHANGELOG.md

      # ---------------------------
      # 8) 创建 GitHub Release + 上传产物
      # ---------------------------
      - name: Create GitHub Release (attach APK/AAB)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: Release ${{ env.TAG }}
          body_path: CHANGELOG.md
          files: |
            release_out/*
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
